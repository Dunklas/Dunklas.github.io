<!doctype html><html lang=en-us><head><title>Custom resources with AWS CDK // </title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.145.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Rickard Andersson"><meta name=description content><link rel=stylesheet href=/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Custom resources with AWS CDK"><meta name=twitter:description content="CloudFormation custom resources is a great way to extend the functionality of CloudFormation. With custom resources you can run any custom logic in response to stack events. Example of use cases could be to create resources which CloudFormation has no support for, make requests to some external (non AWS) API, or maybe something not related to infrastructure at all, such as running a suite of smoke tests or seeding a database."><meta property="og:url" content="https://dunklas.github.io/posts/aws/custom_resources_cdk/"><meta property="og:title" content="Custom resources with AWS CDK"><meta property="og:description" content="CloudFormation custom resources is a great way to extend the functionality of CloudFormation. With custom resources you can run any custom logic in response to stack events. Example of use cases could be to create resources which CloudFormation has no support for, make requests to some external (non AWS) API, or maybe something not related to infrastructure at all, such as running a suite of smoke tests or seeding a database."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-20T05:21:00+00:00"><meta property="article:modified_time" content="2021-04-20T05:21:00+00:00"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Cdk"></head><body><header class=app-header><a href=/><img class=app-header-avatar src=/kittelsen.jpg alt="Rickard Andersson"></a>
<span class=app-header-title></span><p></p></header><main class=app-container><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><style type=text/css>img[src$='#center']{display:block;margin:1rem auto;max-width:100%;height:auto}</style><article class=post><header class=post-header><h1 class=post-title>Custom resources with AWS CDK</h1><div class=post-meta><div><svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Apr 20, 2021</div><div><svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
4 min read</div><div><svg class="icon icon-tag" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
<a class=tag href=https://dunklas.github.io/tags/aws/>Aws</a>
<a class=tag href=https://dunklas.github.io/tags/cdk/>Cdk</a></div></div></header><div class=post-content><p>CloudFormation custom resources is a great way to extend the functionality of CloudFormation. With custom resources you can run any custom logic in response to stack events. Example of use cases could be to create resources which CloudFormation has no support for, make requests to some external (non AWS) API, or maybe something not related to infrastructure at all, such as running a suite of smoke tests or seeding a database.</p><p>I recently implemented a lambda-backed custom resource with AWS CDK, and the gist of it is something like below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { Function, <span style=color:#a6e22e>Runtime</span>, <span style=color:#a6e22e>Code</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Provider</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-cdk/custom-resources&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>RetentionDays</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-cdk/aws-logs&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>myLambda</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Function(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>`lambda-id`</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>runtime</span>: <span style=color:#66d9ef>Runtime.NODEJS_12_X</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>code</span>: <span style=color:#66d9ef>Code.fromAsset</span>(<span style=color:#e6db74>&#34;path/to/code/&#34;</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>handler</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;index.handler&#34;</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Provider</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#34;custom-resource-provider-id&#34;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>onEventHandler</span>: <span style=color:#66d9ef>myLambda</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>My understanding is that the <code>Provider</code> is the layer between CloudFormation and the lambda function. It listens to notifications from CloudFormation and deliver responses from the lambda function back to CloudFormation.</p><p>To actually use the the custom resource, you&rsquo;ll need to include a <code>CustomResource</code> with a service token from the <code>Provider</code>, like below. I think the service token is what tells CloudFormation about where requests should be sent, but I&rsquo;m not sure how this is implemented in the <code>@aws-cdk/custom-resources.Provider</code> construct.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>CustomResource</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-cdk/core&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CustomResource</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>`custom-resource-id`</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>serviceToken</span>: <span style=color:#66d9ef>provider.serviceToken</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>properties</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>anyProperties</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;that your lambda needs&#34;</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Once the <code>CustomResource</code> has been added to a stack, the lambda function will be called for different stack events. When the resource is added to a stack, it will be called with a <code>Create</code> event. If any properties are changed, it will be called with an <code>Update</code> event. Finally, if the <code>CustomResource</code> is removed from a stack, the lambda will be called with a <code>Delete</code> event. Below is a skeleton of how you can react to these events in the lambda function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>anyProperties</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>ResourceProperties</span>.<span style=color:#a6e22e>anyResourceProperties</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>RequestType</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;Create&#34;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Perform create logic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;Update&#34;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Perform update logic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;Delete&#34;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Perform delete logic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=implementing-the-lambda-function>Implementing the lambda function</h2><p>The lambda function will be called with an input event that looks kind of like below (plus some more properties, see <a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/crpg-ref-requests.html target=_blank rel=noopener>documentation</a> for a full list)</p><p>Example of event input</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;RequestType&#34;</span>: <span style=color:#e6db74>&#34;Create&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;LogicalResourceId&#34;</span>: <span style=color:#e6db74>&#34;SomeCustomResource&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;PhysicalResourceId&#34;</span>: <span style=color:#e6db74>&#34;AnImportantId!&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;ResourceProperties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;anyProperties&#34;</span>: <span style=color:#e6db74>&#34;that was provided to this resource&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;OldResourceProperties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;anyProperties&#34;</span>: <span style=color:#e6db74>&#34;that previously was provided to this resource&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;RequestId&#34;</span>: <span style=color:#e6db74>&#34;Unique id for this request&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that <code>PhysicalResourceId</code> is not included for <code>Create</code> events, and <code>OldResourceProperties</code> is only included for <code>Update</code> events.</p><p>To respond to the stack events, your lambda function need to return a JSON object. The properties which the JSON object may contain is documented <a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/crpg-ref-responses.html target=_blank rel=noopener>here</a>. However, for the <code>@aws-cdk/custom-resources.Provider</code> construct there are no required fields for the JSON object. If the lambda function is invoked successfully, a <code>SUCCESS</code> will be reported back to CloudFormation, and if an error is thrown a <code>FAILURE</code> will be reported.</p><p>Even though no fields are required, you should think carefully about what <code>PhysicalResourceId</code> that is returned in response to a <code>Create</code> event (if omitted, it will default to <code>RequestId</code>). This is what CloudFormation uses to identify your resource, and it will be provided in subsequent <code>Update</code> and <code>Delete</code> events.</p><p>Example of event output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;PhysicalResourceId&#34;</span>: <span style=color:#e6db74>&#34;an-important-id!&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It&rsquo;s equally important to consider what <code>PhysicalResourceId</code> that is returned in response to <code>Update</code> events. If the <code>PhysicalResourceId</code> is different from the one used during the <code>Create</code> event, CloudFormation will consider this as a resource replacement, and will emit a <code>Delete</code> event for the old custom resource. In order to decide if an <code>Update</code> should be treated as a replacement, you can compare values of <code>ResourceProperties</code> and <code>OldResourceProperties</code>. Perhaps a change in some properties should be considered a replacement, while a change in other properties should not.</p><p>In the CustomResource that I recently implemented, the whole point of it was to manage a resource in an external (non-AWS) service. In response to the <code>Create</code> event I made a HTTP request to the external API for creation of a resource. The response from the external API included an id for my newly created resource, which was a great fit as <code>PhysicalResourceId</code>. Since the <code>PhysicalResourceId</code> is included in the <code>Update</code> and <code>Delete</code> events, I could pick it up from the event data and make further requests to the external API, specifically for my resource.</p></div><div class=post-footer></div></article></main></body></html>